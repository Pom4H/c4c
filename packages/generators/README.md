# @c4c/generators

Generate OpenAPI specs and TypeScript clients from c4c procedure registries.

## Installation

```bash
pnpm add @c4c/generators
```

## Features

- ✅ **OpenAPI 3.0 generation** from Zod schemas
- ✅ **TypeScript client generation** with full type safety
- ✅ **Auth-aware clients** - automatically detect and handle protected procedures
- ✅ **Dynamic token support** - refresh tokens automatically
- ✅ **Zero runtime overhead** - generated code has no dependencies

## OpenAPI Generation

Generate OpenAPI 3.0 specifications from your procedure registry:

```typescript
import { generateOpenAPIJSON } from "@c4c/generators";
import { collectRegistry } from "@c4c/core";

const registry = await collectRegistry("src/handlers");

const spec = generateOpenAPIJSON(registry, {
  title: "My API",
  version: "1.0.0",
  description: "Auto-generated API documentation",
  servers: [
    { url: "http://localhost:3000", description: "Development" },
    { url: "https://api.example.com", description: "Production" },
  ],
});

// Save to file
await fs.writeFile("openapi.json", spec);
```

**Output:**
```json
{
  "openapi": "3.0.0",
  "info": {
    "title": "My API",
    "version": "1.0.0"
  },
  "paths": {
    "/rpc/users.create": {
      "post": {
        "operationId": "users.create",
        "summary": "Create a new user",
        "requestBody": { ... },
        "responses": { ... }
      }
    }
  }
}
```

## TypeScript Client Generation

Generate type-safe TypeScript clients:

```typescript
import { generateRpcClientModule } from "@c4c/generators";
import { collectRegistry } from "@c4c/core";

const registry = await collectRegistry("src/handlers");

const clientCode = generateRpcClientModule(registry, {
  baseUrl: "http://localhost:3000",
});

// Save to file
await fs.writeFile("src/generated/client.ts", clientCode);
```

**Generated client:**
```typescript
// This file is auto-generated by @c4c/generators.
// Do not edit manually.

export interface TsdevClientOptions {
  baseUrl?: string;
  fetch?: typeof fetch;
  headers?: Record<string, string>;
  authToken?: string;
  getAuthToken?: () => string | undefined | Promise<string | undefined>;
}

export interface ProcedureDefinitions {
  "users.create": {
    input: UsersCreateInput;
    output: UsersCreateOutput;
    requiresAuth: false;
  };
  "users.delete": {
    input: UsersDeleteInput;
    output: UsersDeleteOutput;
    requiresAuth: true; // ← Protected procedure
  };
}

export function createTsdevClient(options: TsdevClientOptions = {}) {
  // ... implementation
}

export type UsersCreateInput = {
  name: string;
  email: string;
};

export type UsersCreateOutput = {
  id: string;
  name: string;
  email: string;
};
```

## Auth-Aware Client Generation

The generator automatically detects protected procedures and adds auth support:

### 1. Mark procedures as protected

```typescript
import { requireAuth } from "@c4c/policies";

const deleteUserContract = requireAuth({
  name: "users.delete",
  description: "Delete user",
  input: z.object({ userId: z.string() }),
  output: z.object({ success: z.boolean() }),
  metadata: {
    exposure: "external",
    roles: ["api-endpoint", "sdk-client"],
  },
}, {
  requiredRoles: ["admin"],
  authScheme: "Bearer",
});
```

Or use `createAuthProcedure`:

```typescript
import { createAuthProcedure } from "@c4c/policies";

export const deleteUser = createAuthProcedure({
  contract: deleteUserContract,
  handler: async (input) => { /* ... */ },
  auth: {
    requiredRoles: ["admin"],
  },
});
```

### 2. Generate client

```typescript
const clientCode = generateRpcClientModule(registry);
```

### 3. Generated client includes auth metadata

```typescript
const PROCEDURE_METADATA = {
  "users.delete": {
    requiresAuth: true,
    requiredRoles: ["admin"],
    authScheme: "Bearer",
  },
  // ...
} as const;

export function createTsdevClient(options: TsdevClientOptions = {}) {
  const invoke = async (name, input) => {
    const metadata = PROCEDURE_METADATA[name] ?? { requiresAuth: false };
    const headers = { ...resolved.headers };

    // Automatically add Authorization header for protected procedures
    if (metadata.requiresAuth) {
      let token = resolved.authToken;
      if (!token && resolved.getAuthToken) {
        token = await resolved.getAuthToken();
      }
      if (token) {
        const scheme = metadata.authScheme ?? "Bearer";
        headers["Authorization"] = `${scheme} ${token}`;
      } else {
        console.warn(`Procedure "${name}" requires auth but no token provided`);
      }
    }

    const response = await resolved.fetch(`${baseUrl}/rpc/${name}`, {
      method: "POST",
      headers,
      body: JSON.stringify(input),
    });
    
    return await response.json();
  };

  return { invoke, procedures: { /* ... */ } };
}
```

## Client Usage

### Static Token

```typescript
import { createTsdevClient } from "./generated/client";

const client = createTsdevClient({
  baseUrl: "http://localhost:3000",
  authToken: "your-jwt-token",
});

// Protected procedure - Authorization header added automatically
const result = await client.procedures.deleteUser({ userId: "123" });

// Public procedure - No auth header
const user = await client.procedures.createUser({ 
  name: "Alice", 
  email: "alice@example.com" 
});
```

### Dynamic Token

```typescript
const client = createTsdevClient({
  baseUrl: "http://localhost:3000",
  getAuthToken: async () => {
    // Get token from storage
    let token = localStorage.getItem("authToken");
    
    // Refresh if expired
    if (isExpired(token)) {
      token = await refreshToken();
      localStorage.setItem("authToken", token);
    }
    
    return token;
  },
});

// getAuthToken() called automatically for protected procedures
await client.procedures.deleteUser({ userId: "123" });
```

### React Integration

```typescript
import { useMemo } from "react";
import { createTsdevClient } from "./generated/client";
import { useAuth } from "./hooks/useAuth";

function useApiClient() {
  const { token } = useAuth();
  
  return useMemo(
    () => createTsdevClient({
      baseUrl: import.meta.env.VITE_API_URL,
      authToken: token,
    }),
    [token]
  );
}

function MyComponent() {
  const client = useApiClient();
  
  const handleDelete = async () => {
    try {
      await client.procedures.deleteUser({ userId: "123" });
    } catch (error) {
      console.error("Delete failed:", error);
    }
  };
  
  return <button onClick={handleDelete}>Delete</button>;
}
```

### Node.js Backend

```typescript
import { createTsdevClient } from "./generated/client";

const client = createTsdevClient({
  baseUrl: "http://internal-api:3000",
  getAuthToken: async () => {
    // Service account token
    return process.env.SERVICE_ACCOUNT_TOKEN;
  },
});

// Use in API routes
app.get("/admin/users", async (req, res) => {
  const users = await client.procedures.listUsers({ limit: 100 });
  res.json(users);
});
```

## CLI Usage

### Generate OpenAPI Spec

```bash
c4c generate openapi \
  --root ./src/handlers \
  --out ./openapi.json \
  --title "My API" \
  --version "1.0.0"
```

### Generate TypeScript Client

```bash
c4c generate client \
  --root ./src/handlers \
  --out ./src/generated/client.ts \
  --base-url "http://localhost:3000"
```

## Programmatic API

### generateOpenAPIJSON

```typescript
function generateOpenAPIJSON(
  registry: Registry,
  options?: {
    title?: string;
    version?: string;
    description?: string;
    servers?: Array<{ url: string; description?: string }>;
  }
): string;
```

**Example:**
```typescript
const spec = generateOpenAPIJSON(registry, {
  title: "My API",
  version: "1.0.0",
  description: "API documentation",
  servers: [
    { url: "http://localhost:3000", description: "Development" },
  ],
});
```

### generateRpcClientModule

```typescript
function generateRpcClientModule(
  registry: Registry,
  options?: {
    baseUrl?: string;
  }
): string;
```

**Example:**
```typescript
const clientCode = generateRpcClientModule(registry, {
  baseUrl: "http://localhost:3000",
});
```

## Generated Client API

### TsdevClientOptions

```typescript
interface TsdevClientOptions {
  /** Base URL of the API server */
  baseUrl?: string;
  
  /** Custom fetch implementation */
  fetch?: typeof fetch;
  
  /** Additional headers to include in all requests */
  headers?: Record<string, string>;
  
  /** Static authentication token for protected procedures */
  authToken?: string;
  
  /** Dynamic token retrieval function */
  getAuthToken?: () => string | undefined | Promise<string | undefined>;
}
```

### ProcedureDefinitions

```typescript
interface ProcedureDefinitions {
  [procedureName: string]: {
    input: InputType;
    output: OutputType;
    requiresAuth: boolean;
  };
}
```

### createTsdevClient

```typescript
function createTsdevClient(options?: TsdevClientOptions): {
  invoke: <P extends keyof ProcedureDefinitions>(
    name: P,
    input: ProcedureDefinitions[P]["input"]
  ) => Promise<ProcedureDefinitions[P]["output"]>;
  
  procedures: {
    [P in keyof ProcedureDefinitions]: (
      input: ProcedureDefinitions[P]["input"]
    ) => Promise<ProcedureDefinitions[P]["output"]>;
  };
}
```

**Usage:**
```typescript
const client = createTsdevClient({ baseUrl: "http://localhost:3000" });

// Generic invoke
const result = await client.invoke("users.create", { 
  name: "Alice", 
  email: "alice@example.com" 
});

// Typed procedures
const user = await client.procedures.createUser({ 
  name: "Bob", 
  email: "bob@example.com" 
});
```

## Type Safety

The generated client is fully type-safe:

```typescript
// ✅ Type-safe input
await client.procedures.createUser({
  name: "Alice",
  email: "alice@example.com"
});

// ❌ TypeScript error - missing required field
await client.procedures.createUser({
  name: "Alice"
  // Error: Property 'email' is missing
});

// ❌ TypeScript error - wrong type
await client.procedures.createUser({
  name: 123, // Error: Type 'number' is not assignable to type 'string'
  email: "alice@example.com"
});

// ✅ Type-safe output
const result = await client.procedures.createUser({ ... });
result.id; // string
result.name; // string
result.email; // string
result.foo; // Error: Property 'foo' does not exist
```

## Schema Conversion

Zod schemas are converted to TypeScript types:

| Zod Type | TypeScript Type |
|----------|----------------|
| `z.string()` | `string` |
| `z.number()` | `number` |
| `z.boolean()` | `boolean` |
| `z.date()` | `string` |
| `z.object({ ... })` | `{ ... }` |
| `z.array(T)` | `Array<T>` |
| `z.union([A, B])` | `A \| B` |
| `z.optional()` | `T \| undefined` |
| `z.nullable()` | `T \| null` |
| `z.literal("foo")` | `"foo"` |
| `z.enum(["a", "b"])` | `"a" \| "b"` |

**Example:**
```typescript
// Zod schema
const schema = z.object({
  name: z.string(),
  age: z.number().optional(),
  role: z.enum(["admin", "user"]),
  tags: z.array(z.string()),
});

// Generated TypeScript type
type SchemaType = {
  name: string;
  age?: number;
  role: "admin" | "user";
  tags: Array<string>;
};
```

## Advanced Usage

### Custom Fetch

```typescript
import nodeFetch from "node-fetch";

const client = createTsdevClient({
  baseUrl: "http://localhost:3000",
  fetch: nodeFetch as any,
});
```

### Custom Headers

```typescript
const client = createTsdevClient({
  baseUrl: "http://localhost:3000",
  headers: {
    "X-API-Version": "1.0",
    "X-Client-ID": "my-app",
  },
});
```

### Error Handling

```typescript
try {
  const result = await client.procedures.createUser({ ... });
} catch (error) {
  if (error.message.includes("400")) {
    // Validation error
  } else if (error.message.includes("401")) {
    // Authentication required
  } else if (error.message.includes("403")) {
    // Insufficient permissions
  } else {
    // Other error
  }
}
```

## Best Practices

1. **Regenerate after changes** - Run generation after modifying procedures
2. **Version your API** - Include version in OpenAPI spec
3. **Commit generated files** - Keep generated code in version control
4. **Use TypeScript** - Take advantage of full type safety
5. **Handle auth tokens** - Use `getAuthToken` for dynamic tokens
6. **Error handling** - Always catch and handle errors
7. **Test generated code** - Include in your test suite

## Examples

See [examples/basic](../../examples/basic) for complete examples:
- `src/handlers/auth-example.ts` - Protected procedures
- `src/client-auth-example.ts` - Client usage examples
- `scripts/generate-client-demo.ts` - Generation demo

## See Also

- [@c4c/core](../core) - Core types and execution
- [@c4c/policies](../policies) - Auth and other policies
- [@c4c/adapters](../adapters) - HTTP adapters
